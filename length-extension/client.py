import json
import urllib.request
import urllib.parse
import urllib.error
import base64

import os

BASE_URL = "http://pac.bouillaguet.info/TP2/"
ENCODING = 'utf-8'

class ServerError(Exception):
    def __init__(self, code=None, msg=None):
        self.code = code
        self.msg = None

class Server:
    def __init__(self, base_url):
        self.base = base_url

    def query(self, url, parameters=None ):
         url = self.base + url
         try:
            request = urllib.request.Request(url)
            data = None
            if parameters is not None:
                data = json.dumps(parameters).encode()
                request.add_header('Content-type', 'application/json')
            with urllib.request.urlopen(request, data) as connexion:
                result = connexion.read().decode()
                if connexion.info()['Content-Type'] == "application/json":
                    result = json.loads(result)
            return result
         except urllib.error.HTTPError as e:
             raise ServerError(e.code, e.read().decode()) from None

if __name__ == "__main__":
  server = Server(BASE_URL)

  response = server.query('/length-extension/blurb-generator/sommerard')

  # ./hash_extender -d '4C6F727371756520746F7574206573742066696E69206C6F7273717565206C276F6E2061676F6E6973650A536E6F6220756E2070657520737572206C657320626F7264732064657320626F72647320666F6E64616D656E746175780A556E6520746F676520696C20706F727461697420717569206E27C3A97461697420706173206465206D6973650A446573206E6172636973736573206F6E20637565696C6C65206F75206269656E206F6E20657374206465732076656175780A447520766F6973696E206C65205061706F75207375C3A765206C2761706F70687973650A4FC3B92076656E6169656E7420706172206D696C6C69657273207327C3A963686F756572206C657320686172656E63656175780A4465206C61206D6F7274206F6E20766F75732067726566666520756E65206F7264652062C3A2746172646973650A4C6F72737175276F6E20766F79616974206175206C6F696E20666C616D626572206C65732061726272697373656175780A44752047616E6765206175204D616C61626172206C65206C6F726420616E676C616973207A6F7A6F7474650A436F6D6D6520C3A0204368616E6465726E61676F72206C65206D616E616E742073656E74206C612063726F7474650A4C6520636F6C6F6E656C207327C3A9706F6E676520756E20626C61736F6E2064616E73206C61206D61696E0A426172646520717565207475206D6520706C61697320746F756A6F75727320747520736F6C696C6F717565730A4F6E206D6574746169742073616E73206661C3A76F6E2073657320706C757320696E666563746573206C6F717565730A4C27C3A963752064652076616972206F752064276F72206E65206475726520717527756E206D6174696E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E2E' --data-format=hex -s '92e1afb92d63e418a65081674b6cede557a44b38466e0a99afeef90be47e88bd' -a '736f6d6d6572617264' --append-format=hex -f sha256 -l 32
  parameters = { 'tag': '328c983cbde44426d96441b1d9686029e1de3946e51a42415289dcfa533167d8', 'message': '4c6f727371756520746f7574206573742066696e69206c6f7273717565206c276f6e2061676f6e6973650a536e6f6220756e2070657520737572206c657320626f7264732064657320626f72647320666f6e64616d656e746175780a556e6520746f676520696c20706f727461697420717569206e27c3a97461697420706173206465206d6973650a446573206e6172636973736573206f6e20637565696c6c65206f75206269656e206f6e20657374206465732076656175780a447520766f6973696e206c65205061706f75207375c3a765206c2761706f70687973650a4fc3b92076656e6169656e7420706172206d696c6c69657273207327c3a963686f756572206c657320686172656e63656175780a4465206c61206d6f7274206f6e20766f75732067726566666520756e65206f7264652062c3a2746172646973650a4c6f72737175276f6e20766f79616974206175206c6f696e20666c616d626572206c65732061726272697373656175780a44752047616e6765206175204d616c61626172206c65206c6f726420616e676c616973207a6f7a6f7474650a436f6d6d6520c3a0204368616e6465726e61676f72206c65206d616e616e742073656e74206c612063726f7474650a4c6520636f6c6f6e656c207327c3a9706f6e676520756e20626c61736f6e2064616e73206c61206d61696e0a426172646520717565207475206d6520706c61697320746f756a6f75727320747520736f6c696c6f717565730a4f6e206d6574746169742073616e73206661c3a76f6e2073657320706c757320696e666563746573206c6f717565730a4c27c3a963752064652076616972206f752064276f72206e65206475726520717527756e206d6174696e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600736f6d6d6572617264' }

  response = server.query('/length-extension/validate/sommerard', parameters)
  print(response)
